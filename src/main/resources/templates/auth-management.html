<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>권한 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .auth-level-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        .search-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .btn-action {
            margin-right: 5px;
        }
        .modal-header {
            background-color: #007bff;
            color: white;
        }
        .form-label {
            font-weight: 600;
        }
        .alert {
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-shield-alt"></i> 권한 관리
                </h2>
                
                <!-- 검색 섹션 -->
                <div class="search-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="searchField" class="form-label">검색 필드</label>
                            <select class="form-select" id="searchField">
                                <option value="">전체</option>
                                <option value="authCd">권한코드</option>
                                <option value="authNm">권한명</option>
                                <option value="authDesc">권한설명</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="searchKeyword" class="form-label">검색어</label>
                            <input type="text" class="form-control" id="searchKeyword" placeholder="검색어를 입력하세요">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-primary" onclick="searchAuths()">
                                    <i class="fas fa-search"></i> 검색
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetSearch()">
                                    <i class="fas fa-undo"></i> 초기화
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 버튼 섹션 -->
                <div class="mb-3">
                    <button type="button" class="btn btn-success" onclick="openCreateModal()">
                        <i class="fas fa-plus"></i> 권한 등록
                    </button>
                    <button type="button" class="btn btn-info" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>

                <!-- 알림 메시지 -->
                <div id="alertMessage" class="alert" style="display: none;"></div>

                <!-- 권한 목록 테이블 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>순번</th>
                                <th>권한코드</th>
                                <th>권한명</th>
                                <th>권한설명</th>
                                <th>권한레벨</th>
                                <th>등록일시</th>
                                <th>수정일시</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="authTableBody">
                            <!-- 데이터가 여기에 로드됩니다 -->
                        </tbody>
                    </table>
                </div>

                <!-- 페이징 -->
                <nav aria-label="권한 목록 페이징">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 페이징이 여기에 생성됩니다 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 권한 등록/수정 모달 -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">권한 등록</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="authForm">
                        <input type="hidden" id="authCd" name="authCd">
                        
                        <div class="mb-3">
                            <label for="authCdInput" class="form-label">권한코드 *</label>
                            <input type="text" class="form-control" id="authCdInput" name="authCdInput" required>
                            <div class="form-text">권한을 식별하는 고유한 코드입니다.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="authNm" class="form-label">권한명 *</label>
                            <input type="text" class="form-control" id="authNm" name="authNm" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="authDesc" class="form-label">권한설명</label>
                            <textarea class="form-control" id="authDesc" name="authDesc" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="authLvl" class="form-label">권한레벨 *</label>
                            <select class="form-select" id="authLvl" name="authLvl" required>
                                <option value="">권한레벨을 선택하세요</option>
                                <option value="1">1 - 최하위 권한</option>
                                <option value="2">2 - 하위 권한</option>
                                <option value="3">3 - 일반 권한</option>
                                <option value="4">4 - 중간 권한</option>
                                <option value="5">5 - 상위 권한</option>
                                <option value="6">6 - 고위 권한</option>
                                <option value="7">7 - 관리자 권한</option>
                                <option value="8">8 - 시스템 관리자</option>
                                <option value="9">9 - 슈퍼 관리자</option>
                                <option value="10">10 - 최고 관리자</option>
                            </select>
                            <div class="form-text">숫자가 클수록 높은 권한을 가집니다.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveAuth()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">권한 삭제 확인</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>정말로 이 권한을 삭제하시겠습니까?</p>
                    <p><strong>권한코드:</strong> <span id="deleteAuthCd"></span></p>
                    <p><strong>권한명:</strong> <span id="deleteAuthNm"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">삭제</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentAuthCd = null;
        let authModal = null;
        let deleteModal = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            authModal = new bootstrap.Modal(document.getElementById('authModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            loadAuthList();
        });

        // 권한 목록 로드
        async function loadAuthList(page = 1) {
            try {
                const searchField = document.getElementById('searchField').value;
                const keyword = document.getElementById('searchKeyword').value;
                
                let url = `/api/auth/list?page=${page}&size=10&sortKey=authLvl&sortOrder=desc`;
                
                if (keyword) {
                    url += `&keyword=${encodeURIComponent(keyword)}`;
                    if (searchField) {
                        url += `&searchField=${encodeURIComponent(searchField)}`;
                    }
                }

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok) {
                    displayAuthList(data.content);
                    displayPagination(data);
                    currentPage = page;
                } else {
                    showAlert('권한 목록을 불러오는데 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('권한 목록을 불러오는데 실패했습니다.', 'danger');
            }
        }

        // 권한 목록 표시
        function displayAuthList(auths) {
            const tbody = document.getElementById('authTableBody');
            tbody.innerHTML = '';

            if (auths.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">등록된 권한이 없습니다.</td></tr>';
                return;
            }

            auths.forEach(auth => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${auth.rowNum}</td>
                    <td><strong>${auth.authCd}</strong></td>
                    <td>${auth.authNm}</td>
                    <td>${auth.authDesc || '-'}</td>
                    <td><span class="badge bg-primary auth-level-badge">Level ${auth.authLvl}</span></td>
                    <td>${formatDateTime(auth.regDate)}</td>
                    <td>${formatDateTime(auth.updDate)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewAuth('${auth.authCd}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning btn-action" onclick="editAuth('${auth.authCd}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteAuth('${auth.authCd}', '${auth.authNm}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 페이징 표시
        function displayPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = data.totalPages;
            const currentPage = data.number + 1;

            // 이전 페이지
            if (data.first) {
                pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">이전</span></li>';
            } else {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuthList(${currentPage - 1})">이전</a></li>`;
            }

            // 페이지 번호
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    pagination.innerHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuthList(${i})">${i}</a></li>`;
                }
            }

            // 다음 페이지
            if (data.last) {
                pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">다음</span></li>';
            } else {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadAuthList(${currentPage + 1})">다음</a></li>`;
            }
        }

        // 검색
        function searchAuths() {
            loadAuthList(1);
        }

        // 검색 초기화
        function resetSearch() {
            document.getElementById('searchField').value = '';
            document.getElementById('searchKeyword').value = '';
            loadAuthList(1);
        }

        // 테이블 새로고침
        function refreshTable() {
            loadAuthList(currentPage);
        }

        // 권한 등록 모달 열기
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = '권한 등록';
            document.getElementById('authForm').reset();
            document.getElementById('authCdInput').disabled = false;
            currentAuthCd = null;
            authModal.show();
        }

        // 권한 상세보기
        async function viewAuth(authCd) {
            try {
                const response = await fetch(`/api/auth/${authCd}`);
                if (response.ok) {
                    const auth = await response.json();
                    alert(`권한 상세 정보\n\n권한코드: ${auth.authCd}\n권한명: ${auth.authNm}\n권한설명: ${auth.authDesc || '-'}\n권한레벨: ${auth.authLvl}`);
                } else {
                    showAlert('권한 정보를 불러오는데 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('권한 정보를 불러오는데 실패했습니다.', 'danger');
            }
        }

        // 권한 수정 모달 열기
        async function editAuth(authCd) {
            try {
                const response = await fetch(`/api/auth/${authCd}`);
                if (response.ok) {
                    const auth = await response.json();
                    
                    document.getElementById('modalTitle').textContent = '권한 수정';
                    document.getElementById('authCdInput').value = auth.authCd;
                    document.getElementById('authCdInput').disabled = true;
                    document.getElementById('authNm').value = auth.authNm;
                    document.getElementById('authDesc').value = auth.authDesc || '';
                    document.getElementById('authLvl').value = auth.authLvl;
                    
                    currentAuthCd = authCd;
                    authModal.show();
                } else {
                    showAlert('권한 정보를 불러오는데 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('권한 정보를 불러오는데 실패했습니다.', 'danger');
            }
        }

        // 권한 삭제 모달 열기
        function deleteAuth(authCd, authNm) {
            document.getElementById('deleteAuthCd').textContent = authCd;
            document.getElementById('deleteAuthNm').textContent = authNm;
            currentAuthCd = authCd;
            deleteModal.show();
        }

        // 권한 저장
        async function saveAuth() {
            const form = document.getElementById('authForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const authData = {
                authCd: document.getElementById('authCdInput').value,
                authNm: document.getElementById('authNm').value,
                authDesc: document.getElementById('authDesc').value,
                authLvl: parseInt(document.getElementById('authLvl').value)
            };

            try {
                let url, method;
                if (currentAuthCd) {
                    // 수정
                    url = `/api/auth/${currentAuthCd}`;
                    method = 'PUT';
                } else {
                    // 등록
                    url = '/api/auth';
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(authData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(result.message, 'success');
                    authModal.hide();
                    loadAuthList(currentPage);
                } else {
                    showAlert(result.message || '저장에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('저장 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 삭제 확인
        async function confirmDelete() {
            try {
                const response = await fetch(`/api/auth/${currentAuthCd}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(result.message, 'success');
                    deleteModal.hide();
                    loadAuthList(currentPage);
                } else {
                    showAlert(result.message || '삭제에 실패했습니다.', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('삭제 중 오류가 발생했습니다.', 'danger');
            }
        }

        // 알림 메시지 표시
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // 날짜/시간 포맷팅
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('ko-KR');
        }
    </script>
</body>
</html> 