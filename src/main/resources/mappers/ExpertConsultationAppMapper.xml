<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.ExpertConsultationAppMapper">

    <!-- 전문가 상담 신청 목록 조회 (페이징) -->
    <select id="selectExpertConsultationAppList" resultType="com.ERI.demo.vo.ExpertConsultationAppVO">
        SELECT 
            APP_SEQ,
            APP_DT,
            APP_TM,
            EMP_ID,
            CNSL_DT,
            CNSL_TM,
            CNSLR_EMP_ID,
            CNSL_TY_CD,
            CNSL_CNTN,
            ANONYMOUS_YN,
            APRV_STS_CD,
            APRV_EMP_ID,
            APRV_DT,
            APRV_TM,
            REJ_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_EXP_CNSL_APP
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.searchType != null and searchCondition.searchType != ''">
                <choose>
                    <when test="searchCondition.searchType == 'content'">
                        AND CNSL_CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND CNSL_CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </otherwise>
                </choose>
            </if>
            <if test="searchCondition.aprvStsCd != null and searchCondition.aprvStsCd != ''">
                AND APRV_STS_CD = #{searchCondition.aprvStsCd}
            </if>
            <if test="searchCondition.anonymousYn != null and searchCondition.anonymousYn != ''">
                AND ANONYMOUS_YN = #{searchCondition.anonymousYn}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND APP_DT >= #{searchCondition.startDate}::date
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND APP_DT &lt;= #{searchCondition.endDate}::date
            </if>
        </if>
        ORDER BY 
        <choose>
            <when test="sortBy == 'appDt'">APP_DT</when>
            <when test="sortBy == 'aprvDt'">APRV_DT</when>
            <otherwise>REG_DT</otherwise>
        </choose>
        <choose>
            <when test="sortDirection == 'ASC'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 전문가 상담 신청 총 개수 조회 -->
    <select id="selectExpertConsultationAppCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_EXP_CNSL_APP
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.searchType != null and searchCondition.searchType != ''">
                <choose>
                    <when test="searchCondition.searchType == 'content'">
                        AND CNSL_CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND CNSL_CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </otherwise>
                </choose>
            </if>
            <if test="searchCondition.aprvStsCd != null and searchCondition.aprvStsCd != ''">
                AND APRV_STS_CD = #{searchCondition.aprvStsCd}
            </if>
            <if test="searchCondition.anonymousYn != null and searchCondition.anonymousYn != ''">
                AND ANONYMOUS_YN = #{searchCondition.anonymousYn}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND APP_DT >= #{searchCondition.startDate}::date
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND APP_DT &lt;= #{searchCondition.endDate}::date
            </if>
        </if>
    </select>

    <!-- 전문가 상담 신청 상세 조회 -->
    <select id="selectExpertConsultationAppBySeq" resultType="com.ERI.demo.vo.ExpertConsultationAppVO">
        SELECT 
            APP_SEQ,
            APP_DT,
            APP_TM,
            EMP_ID,
            CNSL_DT,
            CNSL_TM,
            CNSLR_EMP_ID,
            CNSL_TY_CD,
            CNSL_CNTN,
            ANONYMOUS_YN,
            APRV_STS_CD,
            APRV_EMP_ID,
            APRV_DT,
            APRV_TM,
            REJ_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_EXP_CNSL_APP
        WHERE APP_SEQ = #{appSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

    <!-- 전문가 상담 신청 등록 -->
    <insert id="insertExpertConsultationApp" parameterType="com.ERI.demo.vo.ExpertConsultationAppVO" useGeneratedKeys="true" keyProperty="appSeq">
        INSERT INTO TB_EXP_CNSL_APP (
            APP_DT,
            APP_TM,
            EMP_ID,
            CNSL_DT,
            CNSL_TM,
            CNSLR_EMP_ID,
            CNSL_TY_CD,
            CNSL_CNTN,
            ANONYMOUS_YN,
            APRV_STS_CD,
            DEL_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        ) VALUES (
            #{appDt,jdbcType=DATE},
            #{appTm,jdbcType=TIME},
            #{empId,jdbcType=VARCHAR},
            #{cnslDt,jdbcType=DATE},
            #{cnslTm,jdbcType=TIME},
            #{cnslrEmpId,jdbcType=VARCHAR},
            #{cnslTyCd,jdbcType=VARCHAR},
            #{cnslCntn,jdbcType=VARCHAR},
            #{anonymousYn,jdbcType=CHAR},
            'PENDING',
            'N',
            #{regEmpId,jdbcType=VARCHAR},
            #{updEmpId,jdbcType=VARCHAR},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 전문가 상담 신청 수정 -->
    <update id="updateExpertConsultationApp" parameterType="com.ERI.demo.vo.ExpertConsultationAppVO">
        UPDATE TB_EXP_CNSL_APP
        SET 
            CNSL_DT = #{cnslDt,jdbcType=DATE},
            CNSL_TM = #{cnslTm,jdbcType=TIME},
            CNSLR_EMP_ID = #{cnslrEmpId,jdbcType=VARCHAR},
            CNSL_TY_CD = #{cnslTyCd,jdbcType=VARCHAR},
            CNSL_CNTN = #{cnslCntn,jdbcType=VARCHAR},
            ANONYMOUS_YN = #{anonymousYn,jdbcType=CHAR},
            APRV_STS_CD = #{aprvStsCd,jdbcType=VARCHAR},
            APRV_EMP_ID = #{aprvEmpId,jdbcType=VARCHAR},
            APRV_DT = #{aprvDt,jdbcType=DATE},
            APRV_TM = #{aprvTm,jdbcType=TIME},
            REJ_RSN = #{rejRsn,jdbcType=VARCHAR},
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DT = CURRENT_TIMESTAMP
        WHERE APP_SEQ = #{appSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 전문가 상담 신청 삭제 (논리 삭제) -->
    <update id="deleteExpertConsultationApp">
        UPDATE TB_EXP_CNSL_APP
        SET 
            DEL_YN = 'Y',
            DEL_DT = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{empId,jdbcType=VARCHAR},
            UPD_DT = CURRENT_TIMESTAMP
        WHERE APP_SEQ = #{appSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 내 전문가 상담 신청 목록 조회 -->
    <select id="selectMyExpertConsultationAppList" resultType="com.ERI.demo.vo.ExpertConsultationAppVO">
        SELECT 
            APP_SEQ,
            APP_DT,
            APP_TM,
            EMP_ID,
            CNSL_DT,
            CNSL_TM,
            CNSLR_EMP_ID,
            CNSL_TY_CD,
            CNSL_CNTN,
            ANONYMOUS_YN,
            APRV_STS_CD,
            APRV_EMP_ID,
            APRV_DT,
            APRV_TM,
            REJ_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_EXP_CNSL_APP
        WHERE EMP_ID = #{empId,jdbcType=VARCHAR}
        AND DEL_YN = 'N'
        ORDER BY REG_DT DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 내 전문가 상담 신청 총 개수 조회 -->
    <select id="selectMyExpertConsultationAppCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_EXP_CNSL_APP
        WHERE EMP_ID = #{empId,jdbcType=VARCHAR}
        AND DEL_YN = 'N'
    </select>

</mapper> 