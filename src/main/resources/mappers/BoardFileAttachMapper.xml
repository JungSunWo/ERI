<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.BoardFileAttachMapper">

    <!-- 파일 첨부 등록 -->
    <insert id="insertFileAttach" parameterType="com.ERI.demo.vo.FileAttachVO" useGeneratedKeys="true" keyProperty="fileSeq">
        INSERT INTO TB_BOARD_FILE_ATTACH (
            BOARD_SEQ,
            ORIGINAL_FILE_NAME,
            STORED_FILE_NAME,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_TYPE,
            DOWNLOAD_CNT,
            REG_ID,
            REG_DT,
            UPD_ID,
            UPD_DT,
            DEL_YN
        ) VALUES (
            #{boardSeq,jdbcType=BIGINT},
            #{originalFileName,jdbcType=VARCHAR},
            #{storedFileName,jdbcType=VARCHAR},
            #{filePath,jdbcType=VARCHAR},
            #{fileSize,jdbcType=BIGINT},
            #{fileExt,jdbcType=VARCHAR},
            #{fileType,jdbcType=VARCHAR},
            0,
            #{regId,jdbcType=VARCHAR},
            NOW(),
            #{updId,jdbcType=VARCHAR},
            NOW(),
            'N'
        )
    </insert>

    <!-- 게시글별 파일 첨부 목록 조회 -->
    <select id="selectFileAttachByBoardSeq" parameterType="long" resultType="com.ERI.demo.vo.FileAttachVO">
        SELECT 
            FILE_SEQ,
            BOARD_SEQ,
            ORIGINAL_FILE_NAME,
            STORED_FILE_NAME,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_TYPE,
            DOWNLOAD_CNT,
            REG_ID,
            REG_DT,
            UPD_ID,
            UPD_DT,
            DEL_YN,
            IMAGE_LINKS
        FROM TB_BOARD_FILE_ATTACH
        WHERE BOARD_SEQ = #{boardSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
        ORDER BY FILE_SEQ ASC
    </select>

    <!-- 파일 첨부 상세 조회 -->
    <select id="selectFileAttachBySeq" parameterType="long" resultType="com.ERI.demo.vo.FileAttachVO">
        SELECT 
            FILE_SEQ,
            BOARD_SEQ,
            ORIGINAL_FILE_NAME,
            STORED_FILE_NAME,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_TYPE,
            DOWNLOAD_CNT,
            REG_ID,
            REG_DT,
            UPD_ID,
            UPD_DT,
            DEL_YN,
            IMAGE_LINKS
        FROM TB_BOARD_FILE_ATTACH
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

    <!-- 파일 첨부 삭제 (논리 삭제) -->
    <update id="deleteFileAttach">
        UPDATE TB_BOARD_FILE_ATTACH
        SET DEL_YN = 'Y',
            UPD_ID = #{empId,jdbcType=VARCHAR},
            UPD_DT = NOW()
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
    </update>

    <!-- 게시글별 파일 첨부 전체 삭제 (논리 삭제) -->
    <update id="deleteFileAttachByBoardSeq">
        UPDATE TB_BOARD_FILE_ATTACH
        SET DEL_YN = 'Y',
            UPD_ID = #{empId,jdbcType=VARCHAR},
            UPD_DT = NOW()
        WHERE BOARD_SEQ = #{boardSeq,jdbcType=BIGINT}
    </update>

    <!-- 다운로드 횟수 증가 -->
    <update id="incrementDownloadCnt" parameterType="long">
        UPDATE TB_BOARD_FILE_ATTACH
        SET DOWNLOAD_CNT = DOWNLOAD_CNT + 1,
            UPD_DT = NOW()
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
    </update>

    <!-- 다운로드 횟수 증가 (서비스에서 사용) -->
    <update id="updateDownloadCount" parameterType="long">
        UPDATE TB_BOARD_FILE_ATTACH
        SET DOWNLOAD_CNT = DOWNLOAD_CNT + 1,
            UPD_DT = NOW()
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
    </update>

    <!-- 파일 링크 정보 업데이트 -->
    <update id="updateFileLinks">
        UPDATE TB_BOARD_FILE_ATTACH
        SET IMAGE_LINKS = #{imageLinks},
            UPD_DT = NOW()
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
    </update>

    <!-- 파일 링크 정보 조회 -->
    <select id="selectFileLinks" parameterType="long" resultType="com.ERI.demo.vo.FileAttachVO">
        SELECT 
            FILE_SEQ,
            IMAGE_LINKS
        FROM TB_BOARD_FILE_ATTACH
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

</mapper> 