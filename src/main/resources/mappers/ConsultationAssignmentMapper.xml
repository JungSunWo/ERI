<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.ConsultationAssignmentMapper">

    <!-- 상담 배정 목록 조회 (페이징) -->
    <select id="selectConsultationAssignmentList" resultType="com.ERI.demo.vo.ConsultationAssignmentVO">
        SELECT 
            ASGN_SEQ,
            APP_SEQ,
            CNSLR_EMP_ID,
            ASGN_DT,
            ASGN_TM,
            ASGN_STS_CD,
            ASGN_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_CNSL_ASSIGNMENT
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.appSeq != null">
                AND APP_SEQ = #{searchCondition.appSeq}
            </if>
            <if test="searchCondition.cnslrEmpId != null and searchCondition.cnslrEmpId != ''">
                AND CNSLR_EMP_ID = #{searchCondition.cnslrEmpId}
            </if>
            <if test="searchCondition.asgnStsCd != null and searchCondition.asgnStsCd != ''">
                AND ASGN_STS_CD = #{searchCondition.asgnStsCd}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND ASGN_DT >= #{searchCondition.startDate}::date
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND ASGN_DT &lt;= #{searchCondition.endDate}::date
            </if>
        </if>
        ORDER BY REG_DT DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 상담 배정 총 개수 조회 -->
    <select id="selectConsultationAssignmentCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CNSL_ASSIGNMENT
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.appSeq != null">
                AND APP_SEQ = #{searchCondition.appSeq}
            </if>
            <if test="searchCondition.cnslrEmpId != null and searchCondition.cnslrEmpId != ''">
                AND CNSLR_EMP_ID = #{searchCondition.cnslrEmpId}
            </if>
            <if test="searchCondition.asgnStsCd != null and searchCondition.asgnStsCd != ''">
                AND ASGN_STS_CD = #{searchCondition.asgnStsCd}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND ASGN_DT >= #{searchCondition.startDate}::date
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND ASGN_DT &lt;= #{searchCondition.endDate}::date
            </if>
        </if>
    </select>

    <!-- 상담 배정 상세 조회 -->
    <select id="selectConsultationAssignmentBySeq" resultType="com.ERI.demo.vo.ConsultationAssignmentVO">
        SELECT 
            ASGN_SEQ,
            APP_SEQ,
            CNSLR_EMP_ID,
            ASGN_DT,
            ASGN_TM,
            ASGN_STS_CD,
            ASGN_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_CNSL_ASSIGNMENT
        WHERE ASGN_SEQ = #{asgnSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

    <!-- 신청별 상담 배정 조회 -->
    <select id="selectConsultationAssignmentByAppSeq" resultType="com.ERI.demo.vo.ConsultationAssignmentVO">
        SELECT 
            ASGN_SEQ,
            APP_SEQ,
            CNSLR_EMP_ID,
            ASGN_DT,
            ASGN_TM,
            ASGN_STS_CD,
            ASGN_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_CNSL_ASSIGNMENT
        WHERE APP_SEQ = #{appSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

    <!-- 상담사별 상담 배정 목록 조회 -->
    <select id="selectConsultationAssignmentByCounselor" resultType="com.ERI.demo.vo.ConsultationAssignmentVO">
        SELECT 
            ASGN_SEQ,
            APP_SEQ,
            CNSLR_EMP_ID,
            ASGN_DT,
            ASGN_TM,
            ASGN_STS_CD,
            ASGN_RSN,
            DEL_YN,
            DEL_DT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        FROM TB_CNSL_ASSIGNMENT
        WHERE CNSLR_EMP_ID = #{cnslrEmpId,jdbcType=VARCHAR}
        AND DEL_YN = 'N'
        ORDER BY ASGN_DT ASC, ASGN_TM ASC
    </select>

    <!-- 상담 배정 등록 -->
    <insert id="insertConsultationAssignment" parameterType="com.ERI.demo.vo.ConsultationAssignmentVO" useGeneratedKeys="true" keyProperty="asgnSeq">
        INSERT INTO TB_CNSL_ASSIGNMENT (
            APP_SEQ,
            CNSLR_EMP_ID,
            ASGN_DT,
            ASGN_TM,
            ASGN_STS_CD,
            ASGN_RSN,
            DEL_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DT,
            UPD_DT
        ) VALUES (
            #{appSeq,jdbcType=BIGINT},
            #{cnslrEmpId,jdbcType=VARCHAR},
            #{asgnDt,jdbcType=DATE},
            #{asgnTm,jdbcType=TIME},
            #{asgnStsCd,jdbcType=VARCHAR},
            #{asgnRsn,jdbcType=VARCHAR},
            'N',
            #{regEmpId,jdbcType=VARCHAR},
            #{updEmpId,jdbcType=VARCHAR},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 상담 배정 수정 -->
    <update id="updateConsultationAssignment" parameterType="com.ERI.demo.vo.ConsultationAssignmentVO">
        UPDATE TB_CNSL_ASSIGNMENT
        SET 
            APP_SEQ = #{appSeq,jdbcType=BIGINT},
            CNSLR_EMP_ID = #{cnslrEmpId,jdbcType=VARCHAR},
            ASGN_DT = #{asgnDt,jdbcType=DATE},
            ASGN_TM = #{asgnTm,jdbcType=TIME},
            ASGN_STS_CD = #{asgnStsCd,jdbcType=VARCHAR},
            ASGN_RSN = #{asgnRsn,jdbcType=VARCHAR},
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DT = CURRENT_TIMESTAMP
        WHERE ASGN_SEQ = #{asgnSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 상담 배정 삭제 (논리 삭제) -->
    <update id="deleteConsultationAssignment">
        UPDATE TB_CNSL_ASSIGNMENT
        SET 
            DEL_YN = 'Y',
            DEL_DT = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{empId,jdbcType=VARCHAR},
            UPD_DT = CURRENT_TIMESTAMP
        WHERE ASGN_SEQ = #{asgnSeq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

</mapper> 