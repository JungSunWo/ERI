<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.ConsultationBoardMapper">

    <!-- 상담 게시글 목록 조회 (페이징) -->
    <select id="selectConsultationBoardList" resultType="com.ERI.demo.vo.ConsultationBoardVO">
        SELECT 
            SEQ,
            TTL,
            CNTN,
            STS_CD,
            CATEGORY_CD,
            ANONYMOUS_YN,
            ANONYMOUS_ID,
            NICKNAME,
            FILE_ATTACH_YN,
            VIEW_CNT,
            ANSWER_YN,
            ANSWER_EMP_ID,
            ANSWER_DATE,
            PRIORITY_CD,
            URGENT_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            DEL_YN,
            DEL_DATE,
            REG_DATE,
            UPD_DATE
        FROM TB_CONSULTATION_BOARD
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.searchType != null and searchCondition.searchType != ''">
                <choose>
                    <when test="searchCondition.searchType == 'title'">
                        AND TTL LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <when test="searchCondition.searchType == 'content'">
                        AND CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (TTL LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%') 
                             OR CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
            <if test="searchCondition.categoryCd != null and searchCondition.categoryCd != ''">
                AND CATEGORY_CD = #{searchCondition.categoryCd}
            </if>
            <if test="searchCondition.stsCd != null and searchCondition.stsCd != ''">
                AND STS_CD = #{searchCondition.stsCd}
            </if>
            <if test="searchCondition.anonymousYn != null and searchCondition.anonymousYn != ''">
                AND ANONYMOUS_YN = #{searchCondition.anonymousYn}
            </if>
            <if test="searchCondition.urgentYn != null and searchCondition.urgentYn != ''">
                AND URGENT_YN = #{searchCondition.urgentYn}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND REG_DATE >= #{searchCondition.startDate}::timestamp
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND REG_DATE &lt;= #{searchCondition.endDate}::timestamp + INTERVAL '1 day'
            </if>
        </if>
        ORDER BY 
        <choose>
            <when test="sortBy == 'viewCnt'">VIEW_CNT</when>
            <when test="sortBy == 'answerDate'">ANSWER_DATE</when>
            <otherwise>REG_DATE</otherwise>
        </choose>
        <choose>
            <when test="sortDirection == 'ASC'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 상담 게시글 총 개수 조회 -->
    <select id="selectConsultationBoardCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONSULTATION_BOARD
        WHERE DEL_YN = 'N'
        <if test="searchCondition != null">
            <if test="searchCondition.searchType != null and searchCondition.searchType != ''">
                <choose>
                    <when test="searchCondition.searchType == 'title'">
                        AND TTL LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <when test="searchCondition.searchType == 'content'">
                        AND CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (TTL LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%') 
                             OR CNTN LIKE CONCAT('%', #{searchCondition.searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
            <if test="searchCondition.categoryCd != null and searchCondition.categoryCd != ''">
                AND CATEGORY_CD = #{searchCondition.categoryCd}
            </if>
            <if test="searchCondition.stsCd != null and searchCondition.stsCd != ''">
                AND STS_CD = #{searchCondition.stsCd}
            </if>
            <if test="searchCondition.anonymousYn != null and searchCondition.anonymousYn != ''">
                AND ANONYMOUS_YN = #{searchCondition.anonymousYn}
            </if>
            <if test="searchCondition.urgentYn != null and searchCondition.urgentYn != ''">
                AND URGENT_YN = #{searchCondition.urgentYn}
            </if>
            <if test="searchCondition.startDate != null and searchCondition.startDate != ''">
                AND REG_DATE >= #{searchCondition.startDate}::timestamp
            </if>
            <if test="searchCondition.endDate != null and searchCondition.endDate != ''">
                AND REG_DATE &lt;= #{searchCondition.endDate}::timestamp + INTERVAL '1 day'
            </if>
        </if>
    </select>

    <!-- 상담 게시글 상세 조회 -->
    <select id="selectConsultationBoardBySeq" resultType="com.ERI.demo.vo.ConsultationBoardVO">
        SELECT 
            SEQ,
            TTL,
            CNTN,
            STS_CD,
            CATEGORY_CD,
            ANONYMOUS_YN,
            ANONYMOUS_ID,
            NICKNAME,
            FILE_ATTACH_YN,
            VIEW_CNT,
            ANSWER_YN,
            ANSWER_EMP_ID,
            ANSWER_DATE,
            PRIORITY_CD,
            URGENT_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            DEL_YN,
            DEL_DATE,
            REG_DATE,
            UPD_DATE
        FROM TB_CONSULTATION_BOARD
        WHERE SEQ = #{seq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </select>

    <!-- 상담 게시글 등록 -->
    <insert id="insertConsultationBoard" parameterType="com.ERI.demo.vo.ConsultationBoardVO" useGeneratedKeys="true" keyProperty="seq">
        INSERT INTO TB_CONSULTATION_BOARD (
            TTL,
            CNTN,
            STS_CD,
            CATEGORY_CD,
            ANONYMOUS_YN,
            ANONYMOUS_ID,
            NICKNAME,
            FILE_ATTACH_YN,
            VIEW_CNT,
            ANSWER_YN,
            PRIORITY_CD,
            URGENT_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            DEL_YN,
            REG_DATE,
            UPD_DATE
        ) VALUES (
            #{ttl,jdbcType=VARCHAR},
            #{cntn,jdbcType=VARCHAR},
            #{stsCd,jdbcType=VARCHAR},
            #{categoryCd,jdbcType=VARCHAR},
            #{anonymousYn,jdbcType=CHAR},
            #{anonymousId,jdbcType=BIGINT},
            #{nickname,jdbcType=VARCHAR},
            #{fileAttachYn,jdbcType=CHAR},
            0,
            'N',
            #{priorityCd,jdbcType=VARCHAR},
            #{urgentYn,jdbcType=CHAR},
            #{regEmpId,jdbcType=VARCHAR},
            #{updEmpId,jdbcType=VARCHAR},
            'N',
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 상담 게시글 수정 -->
    <update id="updateConsultationBoard" parameterType="com.ERI.demo.vo.ConsultationBoardVO">
        UPDATE TB_CONSULTATION_BOARD
        SET 
            TTL = #{ttl,jdbcType=VARCHAR},
            CNTN = #{cntn,jdbcType=VARCHAR},
            STS_CD = #{stsCd,jdbcType=VARCHAR},
            CATEGORY_CD = #{categoryCd,jdbcType=VARCHAR},
            ANONYMOUS_YN = #{anonymousYn,jdbcType=CHAR},
            ANONYMOUS_ID = #{anonymousId,jdbcType=BIGINT},
            NICKNAME = #{nickname,jdbcType=VARCHAR},
            FILE_ATTACH_YN = #{fileAttachYn,jdbcType=CHAR},
            PRIORITY_CD = #{priorityCd,jdbcType=VARCHAR},
            URGENT_YN = #{urgentYn,jdbcType=CHAR},
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE SEQ = #{seq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 상담 게시글 삭제 (논리 삭제) -->
    <update id="deleteConsultationBoard">
        UPDATE TB_CONSULTATION_BOARD
        SET 
            DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{empId,jdbcType=VARCHAR},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE SEQ = #{seq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 조회수 증가 -->
    <update id="incrementViewCount">
        UPDATE TB_CONSULTATION_BOARD
        SET VIEW_CNT = VIEW_CNT + 1
        WHERE SEQ = #{seq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 답변 상태 업데이트 -->
    <update id="updateAnswerStatus">
        UPDATE TB_CONSULTATION_BOARD
        SET 
            ANSWER_YN = #{answerYn,jdbcType=CHAR},
            ANSWER_EMP_ID = #{answerEmpId,jdbcType=VARCHAR},
            ANSWER_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE SEQ = #{seq,jdbcType=BIGINT}
        AND DEL_YN = 'N'
    </update>

    <!-- 내가 작성한 상담 게시글 목록 조회 -->
    <select id="selectMyConsultationBoardList" resultType="com.ERI.demo.vo.ConsultationBoardVO">
        SELECT 
            SEQ,
            TTL,
            CNTN,
            STS_CD,
            CATEGORY_CD,
            ANONYMOUS_YN,
            ANONYMOUS_ID,
            NICKNAME,
            FILE_ATTACH_YN,
            VIEW_CNT,
            ANSWER_YN,
            ANSWER_EMP_ID,
            ANSWER_DATE,
            PRIORITY_CD,
            URGENT_YN,
            REG_EMP_ID,
            UPD_EMP_ID,
            DEL_YN,
            DEL_DATE,
            REG_DATE,
            UPD_DATE
        FROM TB_CONSULTATION_BOARD
        WHERE REG_EMP_ID = #{empId,jdbcType=VARCHAR}
        AND DEL_YN = 'N'
        ORDER BY REG_DATE DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 내가 작성한 상담 게시글 총 개수 조회 -->
    <select id="selectMyConsultationBoardCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_CONSULTATION_BOARD
        WHERE REG_EMP_ID = #{empId,jdbcType=VARCHAR}
        AND DEL_YN = 'N'
    </select>

</mapper> 