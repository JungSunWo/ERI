<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.MnuLstMapper">

    <!-- 결과 맵 -->
    <resultMap id="MnuLstResultMap" type="com.ERI.demo.vo.MnuLstVO">
        <id property="mnuCd" column="MNU_CD"/>
        <result property="mnuNm" column="MNU_NM"/>
        <result property="mnuUrl" column="MNU_URL"/>
        <result property="mnuDesc" column="MNU_DESC"/>
        <result property="mnuOrd" column="MNU_ORD"/>
        <result property="mnuLvl" column="MNU_LVL"/>
        <result property="pMnuCd" column="P_MNU_CD"/>
        <result property="mnuUseYn" column="MNU_USE_YN"/>
        <result property="mnuAdminYn" column="MNU_ADMIN_YN"/>
        <result property="rgstEmpId" column="RGST_EMP_ID"/>
        <result property="updtEmpId" column="UPDT_EMP_ID"/>
        <result property="delYn" column="DEL_YN"/>
        <result property="delDate" column="DEL_DATE"/>
        <result property="regEmpId" column="REG_EMP_ID"/>
        <result property="regDate" column="REG_DATE"/>
        <result property="updEmpId" column="UPD_EMP_ID"/>
        <result property="updDate" column="UPD_DATE"/>
        <result property="pMnuNm" column="P_MNU_NM"/>
    </resultMap>

    <!-- 기본 컬럼 -->
    <sql id="BaseColumns">
        MNU_CD, MNU_NM, MNU_URL, MNU_DESC, MNU_ORD, MNU_LVL, P_MNU_CD, 
        MNU_USE_YN, MNU_ADMIN_YN, RGST_EMP_ID, UPDT_EMP_ID, DEL_YN, DEL_DATE, 
        REG_EMP_ID, REG_DATE, UPD_EMP_ID, UPD_DATE
    </sql>

    <!-- 메뉴 목록 조회 (계층 구조) -->
    <select id="selectMenuList" resultMap="MnuLstResultMap">
        SELECT 
            m1.MNU_CD, m1.MNU_NM, m1.MNU_URL, m1.MNU_DESC, m1.MNU_ORD, m1.MNU_LVL, m1.P_MNU_CD,
            m1.MNU_USE_YN, m1.MNU_ADMIN_YN, m1.RGST_EMP_ID, m1.UPDT_EMP_ID, m1.DEL_YN, m1.DEL_DATE,
            m1.REG_EMP_ID, m1.REG_DATE, m1.UPD_EMP_ID, m1.UPD_DATE,
            m2.MNU_NM as P_MNU_NM
        FROM TB_MNU_LST m1
        LEFT JOIN TB_MNU_LST m2 ON m1.P_MNU_CD = m2.MNU_CD
        WHERE m1.DEL_YN = 'N'
        ORDER BY m1.MNU_LVL ASC, m1.MNU_ORD ASC
    </select>

    <!-- 전체 메뉴 목록 조회 (계층 구조) -->
    <select id="selectAllMenus" resultMap="MnuLstResultMap">
        SELECT 
            m1.MNU_CD, m1.MNU_NM, m1.MNU_URL, m1.MNU_DESC, m1.MNU_ORD, m1.MNU_LVL, m1.P_MNU_CD,
            m1.MNU_USE_YN, m1.MNU_ADMIN_YN, m1.RGST_EMP_ID, m1.UPDT_EMP_ID, m1.DEL_YN, m1.DEL_DATE,
            m1.REG_EMP_ID, m1.REG_DATE, m1.UPD_EMP_ID, m1.UPD_DATE,
            m2.MNU_NM as P_MNU_NM
        FROM TB_MNU_LST m1
        LEFT JOIN TB_MNU_LST m2 ON m1.P_MNU_CD = m2.MNU_CD
        WHERE m1.DEL_YN = 'N'
        <if test="isAdmin != null and !isAdmin">
            AND m1.MNU_ADMIN_YN = 'N'
        </if>
        ORDER BY m1.MNU_LVL ASC, m1.MNU_ORD ASC
    </select>

    <!-- 메뉴 목록 조회 (페이징) -->
    <select id="selectMenuListWithPaging" resultMap="MnuLstResultMap">
        SELECT 
            m1.MNU_CD, m1.MNU_NM, m1.MNU_URL, m1.MNU_DESC, m1.MNU_ORD, m1.MNU_LVL, m1.P_MNU_CD,
            m1.MNU_USE_YN, m1.MNU_ADMIN_YN, m1.RGST_EMP_ID, m1.UPDT_EMP_ID, m1.DEL_YN, m1.DEL_DATE,
            m1.REG_EMP_ID, m1.REG_DATE, m1.UPD_EMP_ID, m1.UPD_DATE,
            m2.MNU_NM as P_MNU_NM
        FROM TB_MNU_LST m1
        LEFT JOIN TB_MNU_LST m2 ON m1.P_MNU_CD = m2.MNU_CD
        WHERE m1.DEL_YN = 'N'
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (m1.MNU_NM LIKE CONCAT('%', #{searchKeyword}, '%') 
                 OR m1.MNU_DESC LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        <if test="mnuLvl != null">
            AND m1.MNU_LVL = #{mnuLvl}
        </if>
        <if test="mnuUseYn != null and mnuUseYn != ''">
            AND m1.MNU_USE_YN = #{mnuUseYn}
        </if>
        <if test="mnuAdminYn != null and mnuAdminYn != ''">
            AND m1.MNU_ADMIN_YN = #{mnuAdminYn}
        </if>
        ORDER BY m1.MNU_LVL ASC, m1.MNU_ORD ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 메뉴 총 개수 조회 -->
    <select id="selectMenuCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_MNU_LST m1
        WHERE m1.DEL_YN = 'N'
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (m1.MNU_NM LIKE CONCAT('%', #{searchKeyword}, '%') 
                 OR m1.MNU_DESC LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        <if test="mnuLvl != null">
            AND m1.MNU_LVL = #{mnuLvl}
        </if>
        <if test="mnuUseYn != null and mnuUseYn != ''">
            AND m1.MNU_USE_YN = #{mnuUseYn}
        </if>
        <if test="mnuAdminYn != null and mnuAdminYn != ''">
            AND m1.MNU_ADMIN_YN = #{mnuAdminYn}
        </if>
    </select>

    <!-- 메뉴 상세 조회 -->
    <select id="selectMenuByCd" resultMap="MnuLstResultMap">
        SELECT 
            m1.MNU_CD, m1.MNU_NM, m1.MNU_URL, m1.MNU_DESC, m1.MNU_ORD, m1.MNU_LVL, m1.P_MNU_CD,
            m1.MNU_USE_YN, m1.MNU_ADMIN_YN, m1.RGST_EMP_ID, m1.UPDT_EMP_ID, m1.DEL_YN, m1.DEL_DATE,
            m1.REG_EMP_ID, m1.REG_DATE, m1.UPD_EMP_ID, m1.UPD_DATE,
            m2.MNU_NM as P_MNU_NM
        FROM TB_MNU_LST m1
        LEFT JOIN TB_MNU_LST m2 ON m1.P_MNU_CD = m2.MNU_CD
        WHERE m1.MNU_CD = #{mnuCd}
          AND m1.DEL_YN = 'N'
    </select>

    <!-- 상위 메뉴 목록 조회 (1depth 메뉴만) -->
    <select id="selectParentMenuList" resultMap="MnuLstResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_MNU_LST
        WHERE DEL_YN = 'N'
          AND MNU_LVL = 1
        ORDER BY MNU_ORD ASC
    </select>

    <!-- 하위 메뉴 목록 조회 -->
    <select id="selectSubMenuList" resultMap="MnuLstResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_MNU_LST
        WHERE DEL_YN = 'N'
          AND P_MNU_CD = #{pMnuCd}
        ORDER BY MNU_ORD ASC
    </select>

    <!-- 메뉴 등록 -->
    <insert id="insertMenu" parameterType="com.ERI.demo.vo.MnuLstVO">
        INSERT INTO TB_MNU_LST (
            MNU_CD, MNU_NM, MNU_URL, MNU_DESC, MNU_ORD, MNU_LVL, P_MNU_CD,
            MNU_USE_YN, MNU_ADMIN_YN, RGST_EMP_ID, UPDT_EMP_ID, DEL_YN,
            REG_EMP_ID, UPD_EMP_ID, REG_DATE, UPD_DATE
        ) VALUES (
            #{mnuCd}, #{mnuNm}, #{mnuUrl}, #{mnuDesc}, #{mnuOrd}, #{mnuLvl}, #{pMnuCd},
            #{mnuUseYn}, #{mnuAdminYn}, #{rgstEmpId}, #{updtEmpId}, 'N',
            #{regEmpId}, #{updEmpId}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 메뉴 수정 -->
    <update id="updateMenu" parameterType="com.ERI.demo.vo.MnuLstVO">
        UPDATE TB_MNU_LST
        SET MNU_NM = #{mnuNm},
            MNU_URL = #{mnuUrl},
            MNU_DESC = #{mnuDesc},
            MNU_ORD = #{mnuOrd},
            MNU_LVL = #{mnuLvl},
            P_MNU_CD = #{pMnuCd},
            MNU_USE_YN = #{mnuUseYn},
            MNU_ADMIN_YN = #{mnuAdminYn},
            UPDT_EMP_ID = #{updtEmpId},
            UPD_EMP_ID = #{updEmpId},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE MNU_CD = #{mnuCd}
          AND DEL_YN = 'N'
    </update>

    <!-- 메뉴 삭제 (논리 삭제) -->
    <update id="deleteMenu">
        UPDATE TB_MNU_LST
        SET DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{updEmpId},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE MNU_CD = #{mnuCd}
          AND DEL_YN = 'N'
    </update>

    <!-- 메뉴 순서 변경 -->
    <update id="updateMenuOrder">
        UPDATE TB_MNU_LST
        SET MNU_ORD = #{mnuOrd},
            UPD_EMP_ID = #{updEmpId},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE MNU_CD = #{mnuCd}
          AND DEL_YN = 'N'
    </update>

    <!-- 메뉴 코드 중복 확인 -->
    <select id="checkMenuCdExists" resultType="int">
        SELECT COUNT(*)
        FROM TB_MNU_LST
        WHERE MNU_CD = #{mnuCd}
          AND DEL_YN = 'N'
    </select>

    <!-- 사용자별 접근 가능한 메뉴 목록 조회 -->
    <select id="selectUserAccessibleMenus" resultMap="MnuLstResultMap">
        SELECT 
            m1.MNU_CD, m1.MNU_NM, m1.MNU_URL, m1.MNU_DESC, m1.MNU_ORD, m1.MNU_LVL, m1.P_MNU_CD,
            m1.MNU_USE_YN, m1.MNU_ADMIN_YN, m1.RGST_EMP_ID, m1.UPDT_EMP_ID, m1.DEL_YN, m1.DEL_DATE,
            m1.REG_EMP_ID, m1.REG_DATE, m1.UPD_EMP_ID, m1.UPD_DATE
        FROM TB_MNU_LST m1
        WHERE m1.DEL_YN = 'N'
          AND m1.MNU_USE_YN = 'Y'
        <if test="!isAdmin">
          AND m1.MNU_ADMIN_YN = 'N'
        </if>
        ORDER BY m1.MNU_LVL ASC, m1.MNU_ORD ASC
    </select>

</mapper> 