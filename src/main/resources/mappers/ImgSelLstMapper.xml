<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.ImgSelLstMapper">

    <!-- 결과 맵 -->
    <resultMap id="ImgSelLstResultMap" type="com.ERI.demo.vo.ImgSelLstVO">
        <id property="imgSelSeq" column="IMG_SEL_SEQ"/>
        <result property="imgBrdSeq" column="IMG_BRD_SEQ"/>
        <result property="imgFileSeq" column="IMG_FILE_SEQ"/>
        <result property="selEmpId" column="SEL_EMP_ID"/>
        <result property="selDate" column="SEL_DATE"/>
        <result property="selEmpNm" column="SEL_EMP_NM"/>
        <result property="imgFileNm" column="IMG_FILE_NM"/>
        <result property="imgFilePath" column="IMG_FILE_PATH"/>
        <result property="imgText" column="IMG_TEXT"/>
        <result property="selCnt" column="SEL_CNT"/>
        <result property="selectedEmpList" column="SELECTED_EMP_LIST"/>
    </resultMap>

    <!-- 사용자가 선택한 이미지 목록 조회 -->
    <select id="selectSelectedImageList" resultMap="ImgSelLstResultMap">
        SELECT 
            s.IMG_SEL_SEQ, s.IMG_BRD_SEQ, s.IMG_FILE_SEQ, s.SEL_EMP_ID, s.SEL_DATE,
            CONCAT(e.EMP_NM, ' (', e.ERI_EMP_ID, ')') as SEL_EMP_NM,
            f.IMG_FILE_NM, f.IMG_FILE_PATH, f.IMG_TEXT
        FROM TB_IMG_SEL_LST s
        LEFT JOIN TB_EMP_REF e ON s.SEL_EMP_ID = e.ERI_EMP_ID
        LEFT JOIN TB_IMG_FILE_LST f ON s.IMG_FILE_SEQ = f.IMG_FILE_SEQ
        WHERE s.IMG_BRD_SEQ = #{imgBrdSeq}
          AND s.SEL_EMP_ID = #{selEmpId}
          AND f.DEL_YN = 'N'
        ORDER BY s.SEL_DATE DESC
    </select>

    <!-- 이미지 선택/해제 토글 -->
    <insert id="toggleImageSelection">
        INSERT INTO TB_IMG_SEL_LST (IMG_BRD_SEQ, IMG_FILE_SEQ, SEL_EMP_ID, SEL_DATE)
        VALUES (#{imgBrdSeq}, #{imgFileSeq}, #{selEmpId}, CURRENT_TIMESTAMP)
        ON CONFLICT (IMG_BRD_SEQ, IMG_FILE_SEQ, SEL_EMP_ID) 
        DO DELETE
    </insert>

    <!-- 모든 선택 해제 -->
    <delete id="clearAllSelections">
        DELETE FROM TB_IMG_SEL_LST
        WHERE IMG_BRD_SEQ = #{imgBrdSeq}
          AND SEL_EMP_ID = #{selEmpId}
    </delete>

    <!-- 이미지 선택 통계 조회 -->
    <select id="selectImageSelectionStats" resultMap="ImgSelLstResultMap">
        SELECT 
            f.IMG_FILE_SEQ, f.IMG_FILE_NM, f.IMG_FILE_PATH, f.IMG_TEXT,
            COUNT(s.IMG_SEL_SEQ) as SEL_CNT,
            STRING_AGG(CONCAT(e.EMP_NM, ' (', e.ERI_EMP_ID, ')'), ', ') as SELECTED_EMP_LIST
        FROM TB_IMG_FILE_LST f
        LEFT JOIN TB_IMG_SEL_LST s ON f.IMG_FILE_SEQ = s.IMG_FILE_SEQ
        LEFT JOIN TB_EMP_REF e ON s.SEL_EMP_ID = e.ERI_EMP_ID
        WHERE f.IMG_BRD_SEQ = #{imgBrdSeq}
          AND f.DEL_YN = 'N'
        GROUP BY f.IMG_FILE_SEQ, f.IMG_FILE_NM, f.IMG_FILE_PATH, f.IMG_TEXT
        ORDER BY SEL_CNT DESC, f.IMG_ORDR ASC
    </select>

    <!-- 선택된 이미지 개수 조회 -->
    <select id="countSelectedImages" resultType="int">
        SELECT COUNT(*)
        FROM TB_IMG_SEL_LST
        WHERE IMG_BRD_SEQ = #{imgBrdSeq}
          AND SEL_EMP_ID = #{selEmpId}
    </select>

</mapper> 