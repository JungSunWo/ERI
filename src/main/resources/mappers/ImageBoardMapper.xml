<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mapper.ImageBoardMapper">

    <!-- 결과 맵 -->
    <resultMap id="ImageBoardResultMap" type="com.ERI.demo.vo.ImageBoardVO">
        <id property="imgBrdSeq" column="IMG_BRD_SEQ"/>
        <result property="imgBrdTitl" column="IMG_BRD_TITL"/>
        <result property="imgBrdDesc" column="IMG_BRD_DESC"/>
        <result property="maxSelCnt" column="MAX_SEL_CNT"/>
        <result property="regEmpId" column="REG_EMP_ID"/>
        <result property="updEmpId" column="UPD_EMP_ID"/>
        <result property="delYn" column="DEL_YN"/>
        <result property="delDt" column="DEL_DT"/>
        <result property="regDt" column="REG_DT"/>
        <result property="updDt" column="UPD_DT"/>
    </resultMap>

    <!-- 기본 조회 컬럼 -->
    <sql id="Base_Column_List">
        IMG_BRD_SEQ,
        IMG_BRD_TITL,
        IMG_BRD_DESC,
        MAX_SEL_CNT,
        REG_EMP_ID,
        UPD_EMP_ID,
        DEL_YN,
        DEL_DT,
        REG_DT,
        UPD_DT
    </sql>

    <!-- 기본 WHERE 조건 -->
    <sql id="Base_Where_Clause">
        WHERE DEL_YN = 'N'
        <if test="imgBrdTitl != null and imgBrdTitl != ''">
            AND IMG_BRD_TITL LIKE '%' || #{imgBrdTitl} || '%'
        </if>
        <if test="imgBrdDesc != null and imgBrdDesc != ''">
            AND IMG_BRD_DESC LIKE '%' || #{imgBrdDesc} || '%'
        </if>
        <if test="regEmpId != null and regEmpId != ''">
            AND REG_EMP_ID = #{regEmpId}
        </if>
        <if test="searchType != null and searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND IMG_BRD_TITL LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'description'">
                    AND IMG_BRD_DESC LIKE '%' || #{searchKeyword} || '%'
                </when>
                <when test="searchType == 'regEmpId'">
                    AND REG_EMP_ID LIKE '%' || #{searchKeyword} || '%'
                </when>
            </choose>
        </if>
    </sql>

    <!-- 이미지 게시판 목록 조회 -->
    <select id="selectImageBoardList" parameterType="com.ERI.demo.vo.ImageBoardVO" resultMap="ImageBoardResultMap">
        SELECT 
            <include refid="Base_Column_List"/>
        FROM TB_IMG_BRD_LST
        <include refid="Base_Where_Clause"/>
        <choose>
            <when test="sortBy != null and sortBy != ''">
                ORDER BY ${sortBy} ${sortDirection}
            </when>
            <otherwise>
                ORDER BY IMG_BRD_SEQ DESC
            </otherwise>
        </choose>
        <if test="page != null and size != null">
            LIMIT #{size} OFFSET (#{page} - 1) * #{size}
        </if>
    </select>

    <!-- 이미지 게시판 목록 개수 조회 -->
    <select id="selectImageBoardCount" parameterType="com.ERI.demo.vo.ImageBoardVO" resultType="int">
        SELECT COUNT(*)
        FROM TB_IMG_BRD_LST
        <include refid="Base_Where_Clause"/>
    </select>

    <!-- 이미지 게시판 상세 조회 -->
    <select id="selectImageBoardBySeq" parameterType="long" resultMap="ImageBoardResultMap">
        SELECT 
            <include refid="Base_Column_List"/>
        FROM TB_IMG_BRD_LST
        WHERE IMG_BRD_SEQ = #{imgBrdSeq}
        AND DEL_YN = 'N'
    </select>

    <!-- 이미지 게시판 등록 -->
    <insert id="insertImageBoard" parameterType="com.ERI.demo.vo.ImageBoardVO" useGeneratedKeys="true" keyProperty="imgBrdSeq">
        INSERT INTO TB_IMG_BRD_LST (
            IMG_BRD_TITL,
            IMG_BRD_DESC,
            MAX_SEL_CNT,
            REG_EMP_ID,
            REG_DT,
            DEL_YN
        ) VALUES (
            #{imgBrdTitl},
            #{imgBrdDesc},
            COALESCE(#{maxSelCnt}, 5),
            #{regEmpId},
            CURRENT_TIMESTAMP,
            'N'
        )
    </insert>

    <!-- 이미지 게시판 수정 -->
    <update id="updateImageBoard" parameterType="com.ERI.demo.vo.ImageBoardVO">
        UPDATE TB_IMG_BRD_LST
        SET 
            IMG_BRD_TITL = #{imgBrdTitl},
            IMG_BRD_DESC = #{imgBrdDesc},
            MAX_SEL_CNT = #{maxSelCnt},
            UPD_EMP_ID = #{updEmpId},
            UPD_DT = CURRENT_TIMESTAMP
        WHERE IMG_BRD_SEQ = #{imgBrdSeq}
        AND DEL_YN = 'N'
    </update>

    <!-- 이미지 게시판 삭제 (논리 삭제) -->
    <update id="deleteImageBoard" parameterType="long">
        UPDATE TB_IMG_BRD_LST
        SET 
            DEL_YN = 'Y',
            DEL_DT = CURRENT_TIMESTAMP
        WHERE IMG_BRD_SEQ = #{imgBrdSeq}
        AND DEL_YN = 'N'
    </update>

    <!-- 이미지 게시판 제목으로 조회 -->
    <select id="selectImageBoardByTitle" parameterType="string" resultMap="ImageBoardResultMap">
        SELECT 
            <include refid="Base_Column_List"/>
        FROM TB_IMG_BRD_LST
        WHERE IMG_BRD_TITL = #{imgBrdTitl}
        AND DEL_YN = 'N'
    </select>

    <!-- 최근 등록된 이미지 게시판 목록 조회 -->
    <select id="selectRecentImageBoardList" parameterType="int" resultMap="ImageBoardResultMap">
        SELECT 
            <include refid="Base_Column_List"/>
        FROM TB_IMG_BRD_LST
        WHERE DEL_YN = 'N'
        ORDER BY REG_DT DESC
        LIMIT #{limit}
    </select>

</mapper> 