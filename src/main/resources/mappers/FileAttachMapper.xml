<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.FileAttachMapper">

    <!-- 특정 참조 테이블의 첨부파일 목록 조회 -->
    <select id="selectFileAttachList" resultType="com.ERI.demo.vo.FileAttachVO">
        SELECT 
            FILE_SEQ,
            REF_TBL_CD,
            REF_PK_VAL,
            FILE_NM,
            FILE_SAVE_NM,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_MIME_TYPE,
            FILE_DESC,
            FILE_ORD,
            DOWNLOAD_CNT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DATE,
            UPD_DATE
        FROM TB_FILE_ATTACH
        WHERE REF_TBL_CD = #{refTblCd}
          AND REF_PK_VAL = #{refPkVal}
          AND DEL_YN = 'N'
        ORDER BY FILE_ORD, REG_DATE
    </select>

    <!-- 첨부파일 상세 조회 -->
    <select id="selectFileAttach" resultType="com.ERI.demo.vo.FileAttachVO">
        SELECT 
            FILE_SEQ,
            REF_TBL_CD,
            REF_PK_VAL,
            FILE_NM,
            FILE_SAVE_NM,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_MIME_TYPE,
            FILE_DESC,
            FILE_ORD,
            DOWNLOAD_CNT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DATE,
            UPD_DATE
        FROM TB_FILE_ATTACH
        WHERE FILE_SEQ = #{fileSeq}
          AND DEL_YN = 'N'
    </select>

    <!-- 첨부파일 등록 -->
    <insert id="insertFileAttach" parameterType="com.ERI.demo.vo.FileAttachVO" useGeneratedKeys="true" keyProperty="fileSeq">
        INSERT INTO TB_FILE_ATTACH (
            REF_TBL_CD,
            REF_PK_VAL,
            FILE_NM,
            FILE_SAVE_NM,
            FILE_PATH,
            FILE_SIZE,
            FILE_EXT,
            FILE_MIME_TYPE,
            FILE_DESC,
            FILE_ORD,
            DOWNLOAD_CNT,
            REG_EMP_ID,
            UPD_EMP_ID,
            REG_DATE,
            UPD_DATE,
            DEL_YN
        ) VALUES (
            #{refTblCd},
            #{refPkVal},
            #{fileNm},
            #{fileSaveNm},
            #{filePath},
            #{fileSize},
            #{fileExt},
            #{fileMimeType},
            #{fileDesc},
            #{fileOrd},
            #{downloadCnt},
            #{regEmpId},
            #{updEmpId},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP,
            'N'
        )
    </insert>

    <!-- 첨부파일 다운로드 횟수 증가 -->
    <update id="incrementDownloadCount">
        UPDATE TB_FILE_ATTACH
        SET DOWNLOAD_CNT = DOWNLOAD_CNT + 1,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE FILE_SEQ = #{fileSeq}
          AND DEL_YN = 'N'
    </update>

    <!-- 첨부파일 삭제 (논리 삭제) -->
    <update id="deleteFileAttach">
        UPDATE TB_FILE_ATTACH
        SET DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{empId},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE FILE_SEQ = #{fileSeq}
    </update>

    <!-- 참조 테이블의 모든 첨부파일 삭제 -->
    <update id="deleteFileAttachByRef">
        UPDATE TB_FILE_ATTACH
        SET DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{empId},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE REF_TBL_CD = #{refTblCd}
          AND REF_PK_VAL = #{refPkVal}
          AND DEL_YN = 'N'
    </update>

</mapper> 