<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.FileAttachMapper">

    <!-- 결과 맵 -->
    <resultMap id="FileAttachResultMap" type="com.ERI.demo.vo.FileAttachVO">
        <id property="fileSeq" column="FILE_SEQ"/>
        <result property="refTblCd" column="REF_TBL_CD"/>
        <result property="refPkVal" column="REF_PK_VAL"/>
        <result property="fileNm" column="FILE_NM"/>
        <result property="fileSaveNm" column="FILE_SAVE_NM"/>
        <result property="filePath" column="FILE_PATH"/>
        <result property="fileSize" column="FILE_SIZE"/>
        <result property="fileExt" column="FILE_EXT"/>
        <result property="fileMimeType" column="FILE_MIME_TYPE"/>
        <result property="fileDesc" column="FILE_DESC"/>
        <result property="fileOrd" column="FILE_ORD"/>
        <result property="downloadCnt" column="DOWNLOAD_CNT"/>
        <result property="rgstEmpId" column="RGST_EMP_ID"/>
        <result property="updtEmpId" column="UPDT_EMP_ID"/>
        <result property="delYn" column="DEL_YN"/>
        <result property="delDate" column="DEL_DATE"/>
        <result property="regEmpId" column="REG_EMP_ID"/>
        <result property="updEmpId" column="UPD_EMP_ID"/>
        <result property="regDate" column="REG_DATE"/>
        <result property="updDate" column="UPD_DATE"/>
    </resultMap>

    <!-- 기본 컬럼 -->
    <sql id="BaseColumns">
        FILE_SEQ, REF_TBL_CD, REF_PK_VAL, FILE_NM, FILE_SAVE_NM, FILE_PATH, 
        FILE_SIZE, FILE_EXT, FILE_MIME_TYPE, FILE_DESC, FILE_ORD, DOWNLOAD_CNT,
        RGST_EMP_ID, UPDT_EMP_ID, DEL_YN, DEL_DATE, REG_EMP_ID, UPD_EMP_ID, 
        REG_DATE, UPD_DATE
    </sql>

    <!-- 첨부파일 목록 조회 -->
    <select id="selectFileAttachList" resultMap="FileAttachResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_FILE_ATTACH
        WHERE REF_TBL_CD = #{refTblCd,jdbcType=VARCHAR}
          AND REF_PK_VAL = #{refPkVal,jdbcType=VARCHAR}
          AND DEL_YN = 'N'
        ORDER BY FILE_ORD ASC, FILE_SEQ ASC
    </select>

    <!-- 첨부파일 상세 조회 -->
    <select id="selectFileAttachBySeq" resultMap="FileAttachResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_FILE_ATTACH
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
          AND DEL_YN = 'N'
    </select>

    <!-- 파일명으로 첨부파일 조회 -->
    <select id="selectFileAttachBySaveName" resultMap="FileAttachResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM TB_FILE_ATTACH
        WHERE FILE_SAVE_NM = #{fileSaveNm,jdbcType=VARCHAR}
          AND DEL_YN = 'N'
    </select>

    <!-- 첨부파일 등록 -->
    <insert id="insertFileAttach" parameterType="com.ERI.demo.vo.FileAttachVO" useGeneratedKeys="true" keyProperty="fileSeq">
        INSERT INTO TB_FILE_ATTACH (
            REF_TBL_CD, REF_PK_VAL, FILE_NM, FILE_SAVE_NM, FILE_PATH, 
            FILE_SIZE, FILE_EXT, FILE_MIME_TYPE, FILE_DESC, FILE_ORD, DOWNLOAD_CNT,
            RGST_EMP_ID, UPDT_EMP_ID, DEL_YN, REG_EMP_ID, UPD_EMP_ID, 
            REG_DATE, UPD_DATE
        ) VALUES (
            #{refTblCd,jdbcType=VARCHAR}, #{refPkVal,jdbcType=VARCHAR}, #{fileNm,jdbcType=VARCHAR}, #{fileSaveNm,jdbcType=VARCHAR}, #{filePath,jdbcType=VARCHAR}, 
            #{fileSize,jdbcType=BIGINT}, #{fileExt,jdbcType=VARCHAR}, #{fileMimeType,jdbcType=VARCHAR}, #{fileDesc,jdbcType=VARCHAR}, #{fileOrd,jdbcType=INTEGER}, #{downloadCnt,jdbcType=INTEGER},
            #{rgstEmpId,jdbcType=VARCHAR}, #{updtEmpId,jdbcType=VARCHAR}, 'N', #{regEmpId,jdbcType=VARCHAR}, #{updEmpId,jdbcType=VARCHAR}, 
            CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 첨부파일 수정 -->
    <update id="updateFileAttach" parameterType="com.ERI.demo.vo.FileAttachVO">
        UPDATE TB_FILE_ATTACH
        SET FILE_DESC = #{fileDesc,jdbcType=VARCHAR},
            FILE_ORD = #{fileOrd,jdbcType=INTEGER},
            UPDT_EMP_ID = #{updtEmpId,jdbcType=VARCHAR},
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
          AND DEL_YN = 'N'
    </update>

    <!-- 첨부파일 삭제 (논리 삭제) -->
    <update id="deleteFileAttach">
        UPDATE TB_FILE_ATTACH
        SET DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
          AND DEL_YN = 'N'
    </update>

    <!-- 첨부파일 물리 삭제 -->
    <delete id="deleteFileAttachPhysical">
        DELETE FROM TB_FILE_ATTACH
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
    </delete>

    <!-- 참조 테이블의 모든 첨부파일 삭제 (논리 삭제) -->
    <update id="deleteFileAttachByRef">
        UPDATE TB_FILE_ATTACH
        SET DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_EMP_ID = #{updEmpId,jdbcType=VARCHAR},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE REF_TBL_CD = #{refTblCd,jdbcType=VARCHAR}
          AND REF_PK_VAL = #{refPkVal,jdbcType=VARCHAR}
          AND DEL_YN = 'N'
    </update>

    <!-- 다운로드 횟수 증가 -->
    <update id="updateDownloadCount">
        UPDATE TB_FILE_ATTACH
        SET DOWNLOAD_CNT = DOWNLOAD_CNT + 1,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE FILE_SEQ = #{fileSeq,jdbcType=BIGINT}
          AND DEL_YN = 'N'
    </update>

</mapper> 