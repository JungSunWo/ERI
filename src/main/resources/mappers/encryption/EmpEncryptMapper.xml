<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ERI.demo.mappers.encryption.EmpEncryptMapper">

    <!-- 직원 암호화 정보 저장 -->
    <insert id="insertEmpEncrypt" parameterType="com.ERI.demo.vo.EmpEncryptVO">
        INSERT INTO TB_EMP_ENCRYPT (
            ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE
        ) VALUES (
            #{origEmpNo}, #{encryptEmpNo}, #{origEmpNm}, #{randomEmpNm}, #{origEmpEmail},
            #{encryptAlgorithm}, #{encryptKeyId}, #{encryptIv}, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 직원 암호화 정보 업데이트 -->
    <update id="updateEmpEncrypt" parameterType="com.ERI.demo.vo.EmpEncryptVO">
        UPDATE TB_EMP_ENCRYPT SET
            ORIG_EMP_NO = #{origEmpNo},
            ENCRYPT_EMP_NO = #{encryptEmpNo},
            ORIG_EMP_NM = #{origEmpNm},
            RANDOM_EMP_NM = #{randomEmpNm},
            ORIG_EMP_EMAIL = #{origEmpEmail},
            ENCRYPT_ALGORITHM = #{encryptAlgorithm},
            ENCRYPT_KEY_ID = #{encryptKeyId},
            ENCRYPT_IV = #{encryptIv},
            ENCRYPT_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
    </update>

    <!-- 직원번호로 직원 암호화 정보 조회 -->
    <select id="selectByEmpNo" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ORIG_EMP_NO = #{origEmpNo}
        AND DEL_YN = 'N'
    </select>

    <!-- 해시된 직원번호로 직원 암호화 정보 조회 -->
    <select id="selectByEncryptEmpNo" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ENCRYPT_EMP_NO = #{encryptEmpNo}
        AND DEL_YN = 'N'
    </select>

    <!-- 모든 직원 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectAllEmpEncrypt" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'N'
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 모든 직원 암호화 정보 조회 (삭제된 데이터 포함) -->
    <select id="selectAllEmpEncryptWithDeleted" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 직원 일련번호로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptBySeq" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE EMP_SEQ = #{empSeq}
        AND DEL_YN = 'N'
    </select>

    <!-- 직원 일련번호로 암호화 정보 조회 (삭제된 데이터 포함) -->
    <select id="selectEmpEncryptBySeqWithDeleted" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE EMP_SEQ = #{empSeq}
    </select>

    <!-- 원본 직원번호로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptByOrigEmpNo" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ORIG_EMP_NO = #{origEmpNo}
        AND DEL_YN = 'N'
    </select>

    <!-- 원본 직원명으로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptByOrigEmpNm" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ORIG_EMP_NM = #{origEmpNm}
        AND DEL_YN = 'N'
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 랜덤 변형 한글명으로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptByRandomEmpNm" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE RANDOM_EMP_NM = #{randomEmpNm}
        AND DEL_YN = 'N'
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 직원 일련번호로 논리적 삭제 -->
    <update id="deleteEmpEncryptBySeq">
        UPDATE TB_EMP_ENCRYPT SET
            DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
        AND DEL_YN = 'N'
    </update>

    <!-- 직원 일련번호로 복구 -->
    <update id="restoreEmpEncryptBySeq">
        UPDATE TB_EMP_ENCRYPT SET
            DEL_YN = 'N',
            DEL_DATE = NULL,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
        AND DEL_YN = 'Y'
    </update>

    <!-- 원본 직원번호로 논리적 삭제 -->
    <update id="deleteEmpEncryptByOrigEmpNo">
        UPDATE TB_EMP_ENCRYPT SET
            DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE ORIG_EMP_NO = #{origEmpNo}
        AND DEL_YN = 'N'
    </update>

    <!-- 암호화 알고리즘으로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptByAlgorithm" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ENCRYPT_ALGORITHM = #{encryptAlgorithm}
        AND DEL_YN = 'N'
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 암호화 일시 범위로 암호화 정보 조회 (삭제되지 않은 데이터만) -->
    <select id="selectEmpEncryptByDateRange" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE ENCRYPT_DATE BETWEEN #{startDate}::timestamp AND #{endDate}::timestamp
        AND DEL_YN = 'N'
        ORDER BY ENCRYPT_DATE DESC
    </select>

    <!-- 직원번호와 직원명으로 암호화 정보 검색 (삭제되지 않은 데이터만) -->
    <select id="searchEmpEncrypt" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'N'
        <if test="origEmpNo != null and origEmpNo != ''">
            AND ORIG_EMP_NO LIKE '%' || #{origEmpNo} || '%'
        </if>
        <if test="origEmpNm != null and origEmpNm != ''">
            AND ORIG_EMP_NM LIKE '%' || #{origEmpNm} || '%'
        </if>
        ORDER BY EMP_SEQ DESC
    </select>

    <!-- 삭제된 직원 암호화 정보 조회 -->
    <select id="selectDeletedEmpEncrypt" resultType="com.ERI.demo.vo.EmpEncryptVO">
        SELECT 
            EMP_SEQ, ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE,
            DEL_YN, DEL_DATE, UPD_DATE
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'Y'
        ORDER BY DEL_DATE DESC
    </select>

    <!-- 전체 암호화 정보 개수 조회 (삭제되지 않은 데이터만) -->
    <select id="countAllEmpEncrypt" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'N'
    </select>

    <!-- 전체 암호화 정보 개수 조회 (삭제된 데이터 포함) -->
    <select id="countAllEmpEncryptWithDeleted" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
    </select>

    <!-- 삭제된 암호화 정보 개수 조회 -->
    <select id="countDeletedEmpEncrypt" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'Y'
    </select>

    <!-- 암호화 알고리즘별 암호화 정보 개수 조회 (삭제되지 않은 데이터만) -->
    <select id="countEmpEncryptByAlgorithm" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE ENCRYPT_ALGORITHM = #{encryptAlgorithm}
        AND DEL_YN = 'N'
    </select>

    <!-- 직원 암호화 정보 논리적 삭제 -->
    <update id="deleteEmpEncrypt">
        UPDATE TB_EMP_ENCRYPT SET
            DEL_YN = 'Y',
            DEL_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
        AND DEL_YN = 'N'
    </update>

    <!-- 직원 암호화 정보 복구 -->
    <update id="restoreEmpEncrypt">
        UPDATE TB_EMP_ENCRYPT SET
            DEL_YN = 'N',
            DEL_DATE = NULL,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
        AND DEL_YN = 'Y'
    </update>

    <!-- 직원번호로 중복 체크 -->
    <select id="countByEmpNo" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE ORIG_EMP_NO = #{origEmpNo}
        AND DEL_YN = 'N'
    </select>

    <!-- 해시된 직원번호로 중복 체크 -->
    <select id="countByEncryptEmpNo" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE ENCRYPT_EMP_NO = #{encryptEmpNo}
        AND DEL_YN = 'N'
    </select>



    <!-- 전체 암호화된 직원 수 조회 (스케줄러용) -->
    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'N'
    </select>

    <!-- 이번 달 새로 암호화된 직원 수 조회 (스케줄러용) -->
    <select id="selectMonthlyNewCount" resultType="int">
        <![CDATA[
        SELECT COUNT(*)
        FROM TB_EMP_ENCRYPT
        WHERE DEL_YN = 'N'
        AND ENCRYPT_DATE >= DATE_TRUNC('month', CURRENT_TIMESTAMP)
        ]]>
    </select>

    <!-- 직원 암호화 정보 업데이트 (스케줄러용) -->
    <update id="update" parameterType="com.ERI.demo.vo.EmpEncryptVO">
        UPDATE TB_EMP_ENCRYPT SET
            ORIG_EMP_NO = #{origEmpNo},
            ENCRYPT_EMP_NO = #{encryptEmpNo},
            ORIG_EMP_NM = #{origEmpNm},
            RANDOM_EMP_NM = #{randomEmpNm},
            ORIG_EMP_EMAIL = #{origEmpEmail},
            ENCRYPT_ALGORITHM = #{encryptAlgorithm},
            ENCRYPT_KEY_ID = #{encryptKeyId},
            ENCRYPT_IV = #{encryptIv},
            ENCRYPT_DATE = CURRENT_TIMESTAMP,
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
    </update>

    <!-- 직원 암호화 정보 삽입 (스케줄러용) -->
    <insert id="insert" parameterType="com.ERI.demo.vo.EmpEncryptVO">
        INSERT INTO TB_EMP_ENCRYPT (
            ORIG_EMP_NO, ENCRYPT_EMP_NO, ORIG_EMP_NM, RANDOM_EMP_NM, ORIG_EMP_EMAIL,
            ENCRYPT_ALGORITHM, ENCRYPT_KEY_ID, ENCRYPT_IV, ENCRYPT_DATE
        ) VALUES (
            #{origEmpNo}, #{encryptEmpNo}, #{origEmpNm}, #{randomEmpNm}, #{origEmpEmail},
            #{encryptAlgorithm}, #{encryptKeyId}, #{encryptIv}, CURRENT_TIMESTAMP
        )
    </insert>

    <!-- 이메일만 업데이트 (직원번호와 암호화된 직원번호가 동일한 경우) -->
    <update id="updateEmailOnly">
        UPDATE TB_EMP_ENCRYPT SET
            ORIG_EMP_EMAIL = #{origEmpEmail},
            UPD_DATE = CURRENT_TIMESTAMP
        WHERE EMP_SEQ = #{empSeq}
    </update>

</mapper> 